apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: innabox-devel

# This applies a name prefix to cluster-scoped resources (ClusterRoles,
# ClusterRoleBindings) but does not modify namespaced resources.
transformers:
- prefixTransformer.yaml

labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/managed-by: kustomize
    environment: development

resources:
- ../../base
- ./ca-trust-bundle.yaml

generatorOptions:
  disableNameSuffixHash: true

secretGenerator:
# This expects to find quay credentials in
# files/quay-pull-secret.json.
- name: quay-pull-secret
  files:
  - .dockerconfigjson=files/quay-pull-secret.json
  type: kubernetes.io/dockerconfigjson

# This expects to find an AAP license manifest
# in files/license.zip.
- name: config-as-code-manifest-ig
  files:
    - license.zip=files/license.zip
  options:
    labels:
      cloudkit.openshift.io/project: cloudkit-aap

- name: config-as-code-ig
  options:
    disableNameSuffixHash: true
  literals:
    - AAP_EE_IMAGE=ghcr.io/innabox/cloudkit-aap:6439ee8191b9508c8463f275e4732f28ef0eb847
    - AAP_PROJECT_GIT_URL="https://github.com/innabox/cloudkit-aap"
    - AAP_PROJECT_GIT_BRANCH="6439ee8"

- name: cluster-fulfillment-ig
  options:
    labels:
      cloudkit.openshift.io/project: cloudkit-aap
  literals:
    - CLOUDKIT_VM_OPERATIONS_STORAGE_CLASS="nfs-vm-dynamic"

- name: publish-templates-ig
  literals:
    - CLOUDKIT_TEMPLATE_COLLECTIONS=osac.templates,osac.massopencloud

images:
  - name: ghcr.io/innabox/cloudkit-operator
    digest: sha256:5daf32e67621704713aa156e7d7b4c646d01c557cf72ac4121dbb2a746a69164
  - name: ghcr.io/innabox/fulfillment-service
    newTag: v0.0.30
  - name: ghcr.io/innabox/fulfillment-controller
    newTag: v0.0.30

patches:
  - patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: fulfillment-controller
      spec:
        template:
          spec:
            containers:
              - name: controller
                imagePullPolicy: Always
  - target:
      kind: Deployment
      name: cloudkit-operator-controller-manager
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_CLUSTER_CREATE_WEBHOOK
          value: http://innabox-eda-service:5000/create-hosted-cluster
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_CLUSTER_DELETE_WEBHOOK
          value: http://innabox-eda-service:5000/delete-hosted-cluster
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_MINIMUM_REQUEST_INTERVAL
          value: "2m"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_VM_CREATE_WEBHOOK
          value: http://innabox-eda-service:5000/create-vm
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_VM_DELETE_WEBHOOK
          value: http://innabox-eda-service:5000/delete-vm
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_FULFILLMENT_SERVER_ADDRESS
          value: fulfillment-api:8000
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: CLOUDKIT_FULFILLMENT_TOKEN_FILE
          value: /var/run/secrets/kubernetes.io/serviceaccount/token
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always
  - patch: |
      apiVersion: operator.authorino.kuadrant.io/v1beta1
      kind: Authorino
      metadata:
        name: authorino
      spec:
        volumes:
          items:
          - name: ca-bundle
            configMaps:
            - ca-bundle
            items:
            - key: bundle.pem
              path: ca-bundle.crt
            mountPath: /etc/pki/tls/certs
  # Override issuerUrl (base has :8001, we use port 443 via service mapping)
  # and admin_subjects for innabox-devel namespace
  - patch: |
      apiVersion: authorino.kuadrant.io/v1beta3
      kind: AuthConfig
      metadata:
        name: fulfillment-service
      spec:
        authentication:
          keycloak-jwt:
            jwt:
              issuerUrl: https://keycloak.keycloak.svc.cluster.local/realms/innabox
        authorization:
          fulfillment-api:
            opa:
              rego: |
                import future.keywords.in

                # Define admin subjects for innabox-devel namespace:
                admin_subjects := {
                  "system:serviceaccount:innabox-devel:admin",
                  "system:serviceaccount:innabox-devel:controller",
                  "system:serviceaccount:innabox-devel:template-publisher",
                  "system:serviceaccount:innabox-devel:cloudkit-operator-controller-manager",
                }

                # Get the gRPC method:
                grpc_method := input.context.request.http.path

                # Get the subject name:
                subject_name = input.auth.identity.user.username {
                  input.auth.identity.authnMethod == "serviceaccount"
                }
                subject_name = input.auth.identity.username {
                  input.auth.identity.authnMethod == "jwt"
                }

                # Get the groups (for JWT users):
                subject_groups = input.auth.identity.user.groups {
                  input.auth.identity.authnMethod == "serviceaccount"
                }
                subject_groups = input.auth.identity.groups {
                  input.auth.identity.authnMethod == "jwt"
                }

                # Function to check if an account is an admin account:
                is_admin {
                  subject_name in admin_subjects
                }

                # Function to check if a JWT user is an admin (in admins group or has tenant-admin role):
                is_jwt_admin {
                  input.auth.identity.authnMethod == "jwt"
                  "admins" in subject_groups
                }
                is_jwt_admin {
                  input.auth.identity.authnMethod == "jwt"
                  "tenant-admin" in input.auth.identity.realm_access.roles
                }

                # Function to check if an account is a client account:
                is_client {
                  not is_admin
                  not is_jwt_admin
                }

                # Allow metadata, reflection and health to everyone:
                allow {
                  startswith(grpc_method, "/metadata.")
                }
                allow {
                  startswith(grpc_method, "/grpc.reflection.")
                }
                allow {
                  startswith(grpc_method, "/grpc.health.")
                }

                # Allow specific methods to clients:
                allow {
                  is_client
                  grpc_method in {
                    "/events.v1/Watch",
                    "/fulfillment.v1.ClusterTemplates/Get",
                    "/fulfillment.v1.ClusterTemplates/List",
                    "/fulfillment.v1.Clusters/Create",
                    "/fulfillment.v1.Clusters/Delete",
                    "/fulfillment.v1.Clusters/Get",
                    "/fulfillment.v1.Clusters/GetKubeconfig",
                    "/fulfillment.v1.Clusters/GetKubeconfigViaHttp",
                    "/fulfillment.v1.Clusters/GetPassword",
                    "/fulfillment.v1.Clusters/GetPasswordViaHttp",
                    "/fulfillment.v1.Clusters/List",
                    "/fulfillment.v1.Clusters/Update",
                    "/fulfillment.v1.HostClasses/Get",
                    "/fulfillment.v1.HostClasses/List",
                    "/fulfillment.v1.HostPools/Create",
                    "/fulfillment.v1.HostPools/Delete",
                    "/fulfillment.v1.HostPools/Get",
                    "/fulfillment.v1.HostPools/List",
                    "/fulfillment.v1.HostPools/Update",
                    "/fulfillment.v1.Hosts/Create",
                    "/fulfillment.v1.Hosts/Delete",
                    "/fulfillment.v1.Hosts/Get",
                    "/fulfillment.v1.Hosts/List",
                    "/fulfillment.v1.Hosts/Update",
                    "/fulfillment.v1.VirtualMachineTemplates/Get",
                    "/fulfillment.v1.VirtualMachineTemplates/List",
                    "/fulfillment.v1.VirtualMachines/Create",
                    "/fulfillment.v1.VirtualMachines/Delete",
                    "/fulfillment.v1.VirtualMachines/Get",
                    "/fulfillment.v1.VirtualMachines/List",
                    "/fulfillment.v1.VirtualMachines/Update",
                  }
                }

                # Allow everything to admins (service accounts or JWT users in admins group):
                allow {
                  is_admin
                }
                allow {
                  is_jwt_admin
                }
  - patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: fulfillment-service
      spec:
        template:
          spec:
            containers:
              - name: server
                imagePullPolicy: Always
                command:
                - /usr/local/bin/fulfillment-service
                - start
                - server
                - --log-level=debug
                - --log-headers=true
                - --log-bodies=true
                - "--db-url=postgres://client@fulfillment-database:5432/service?\
                  sslmode=verify-full&\
                  sslcert=/secrets/cert/tls.crt&\
                  sslkey=/secrets/cert/tls.key&\
                  sslrootcert=/secrets/cert/ca.crt"
                - --grpc-listener-network=unix
                - --grpc-listener-address=/run/sockets/server.socket
                # - --grpc-authn-type=guest
                # - --tenancy-logic=guest
                - --grpc-authn-trusted-token-issuers=https://keycloak.keycloak.svc.cluster.local/realms/innabox
                - --grpc-authn-type=external
                - --tenancy-logic=default
